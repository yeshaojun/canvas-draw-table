!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.$DrawTable=e():t.$DrawTable=e()}(self,(()=>(()=>{"use strict";var t={d:(e,s)=>{for(var i in s)t.o(s,i)&&!t.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:s[i]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},e={};t.r(e),t.d(e,{default:()=>i});class s{constructor(t,e){this.config=t,this.mode="select",this.drawType={type:"cell",td:1,tr:1},this.startX=0,this.startY=0,this.moveX=0,this.moveY=0,this.leftDistance=0,this.topDistance=0,this.c=null,this.ctx=null,this.resize=6,this.mouseStatus=null,this.tableStatus=null,this.layers=[],this.history=[],this.deleteHistory=[],this.isOpt="",this.originCurrent=null,this.current=null,this.coord=null,this.currentArray=[],this.currentArrayItem=null,this.base=0,this.scrollRateY=20,this.scrollRateX=20,this.timerX=null,this.timerY=null,this.timerTop=null,this.cellMatchList=[],this.cellflowList=[],this.clientY=0,this.clientX=0,this.match={type:"",index:0},this.noUpdate=!0,this.saveCurrent=[],this.imgRate=1,this.img=new Image,this.modeChange=e,this.tempy=0,this.selectColor=t.selectColor||"#666",this.selectActiveColor=t.selectActiveColor||"red",this.drawSelectColor=t.drawSelectColor||"#0099CC",this.init()}init(){"object"==typeof this.config.dom&&"nodeType"in this.config.dom?this.c=this.config.dom:this.c=document.getElementById(this.config.dom),this.ctx=this.c.getContext("2d"),this.c.width=document.body.clientWidth,this.c.height=document.body.clientHeight-64,this.addMouseEvent(),this.config.url?this.drawImage():this.drawOriginData(),this.addKeyboard()}addMouseEvent(){this.c.onmousedown=this.mousedown.bind(this),this.c.onmousemove=this.mousemove.bind(this),this.c.onmouseup=this.mouseup.bind(this)}mousedown(t){const e=this.windowToCanvas(t.clientX,t.clientY);switch(this.startX=e.x,this.startY=e.y,this.mouseStatus="down",this.mode){case"select":this.originCurrent=this.isPointInRetc(e.x,e.y);break;case"drawSelect":var s=this.layers.findIndex((t=>"select"===t.type));-1!==s&&this.layers.splice(s,1);break;case"move":if(this.current){let t=this.isPointInRetc(e.x,e.y);this.originCurrent=t,t?(this.leftDistance=e.x-t.x1,this.topDistance=e.y-t.y1):(this.mode="select",this.current.type,this.current=null)}else if(this.currentArray.length>0){console.log("批量操作");let t=this.isPointInRetc(e.x,e.y);this.originCurrent=[...this.currentArray],t?this.currentArrayItem=t:(this.mode="select",this.current=null,this.currentArray=[])}break;case"draw":this.originCurrent=null,console.log("draw")}}addKeyboard(){document.addEventListener("keydown",(t=>{t.key&&("delete"===t.key.toString().toLowerCase()&&this.delete(),(t.metaKey&&"z"===t.key.toString().toLowerCase()||t.ctrlKey&&"z"===t.key.toString().toLowerCase())&&this.history.length>0&&this.revoke(),(t.metaKey&&"s"===t.key.toString().toLowerCase()||t.ctrlKey&&"s"===t.key.toString().toLowerCase())&&(this.noUpdate||this.saveDraw()),t.ctrlKey&&"="===t.key&&this.zoom("up"),t.ctrlKey&&"-"===t.key&&this.zoom("down"))}))}mouseup(t){t.preventDefault(),this.clearTimer();const e=this.windowToCanvas(t.clientX,t.clientY);this.mouseStatus="up",this.tableStatus="";let s={},i=[];if(this.match={type:"",index:0},"select"===this.mode||"move"===this.mode){if(console.warn("mode",this.isOpt,t),this.isOpt){if("move"===this.isOpt&&this.currentArray.length>0){let t=[];this.layers.forEach((e=>{-1!==this.currentArray.findIndex((t=>t.key===e.key))&&t.push(e)})),this.currentArray=[...t],this.current=null,this.base=0,this.cellMatchList=[],this.cellflowList=[]}}else if(!this.current||"select"!==this.current.type){let s=this.isPointInRetc(e.x,e.y);if(s){if(t.ctrlKey){let t=this.currentArray.findIndex((t=>t.key===s.key));-1!==t?this.currentArray.splice(t,1):this.currentArray.push(s)}else this.current=s,this.currentArray=[];this.c.style.cursor="move"}else this.c.style.cursor="default"}this.current?this.mode="move":this.current=null,this.draw()}else if("draw"===this.mode&&"draw"===this.isOpt){if(Math.abs(this.moveX-this.startX)>2*this.resize&&Math.abs(this.moveY-this.startY)>2*this.resize){const t="drawSelect"===this.mode?"select":this.drawType.type;if("table"===t){let t=this.drawType.td,e=this.drawType.tr,s=this.moveX-this.startX,h=this.moveY-this.startY;for(let r=0;r<t;r++)for(let l=0;l<e;l++){let o=this.startX+s/t*r,a=this.startX+s/t*(r+1),c=this.startY+h/e*l,n=this.startY+h/e*(l+1),y=this.fixPosition({x1:o,y1:c,x2:a,y2:n,type:"cell",key:(new Date).getTime()+"cell"+o+c,location:this.getCellLocation("",{x1:o,x2:a,y1:c,y2:n})});i.push(y),this.layers.push(y)}this.c.style.cursor="default",this.currentArray=i}else{const e=(new Date).getTime()+("drawSelect"===this.mode?"select":this.drawType.type)+this.startX+this.startY;s=this.fixPosition({x1:this.startX,y1:this.startY,x2:this.moveX,y2:this.moveY,type:t,key:e,coord:this.coord,h:this.drawType.tr,w:this.drawType.td,location:this.getCellLocation("draw"),coordLocation:"table"===this.drawType.type?this.getTableLocation("draw"):{}}),this.layers.push(s),this.current=s}this.mode="move",this.c.style.cursor="default",this.modeChange("select")}else this.isOpt="";this.draw()}else if("drawSelect"===this.mode){const t=(new Date).getTime()+("drawSelect"===this.mode?"select":this.drawType.type)+this.startX+this.startY;this.findSelectArray(this.fixPosition({x1:this.startX,y1:this.startY,x2:this.moveX,y2:this.moveY,type:"select",key:t,location:this.getCellLocation("draw")})),this.isOpt="",this.mode="move",this.c.style.cursor="default",console.log("drawSelect"),this.current=null,this.modeChange("select"),this.draw()}if(this.isOpt&&"drawSelect"!==this.mode){if(this.current&&"select"===this.current.type&&0===this.currentArray.length)return;if(this.noUpdate=this.checkIsSave(),this.history.length>=this.config.historyCount&&this.history.shift(),this.current&&"select"===this.current.type){let t=[];this.layers.forEach((e=>{this.currentArray.forEach((s=>{e.key===s.key&&t.push({...e})}))})),this.history.push({type:this.isOpt,data:t,originData:[...this.currentArray],selectOpt:!0}),this.deleteHistory=[],this.currentArray=t}else{if(this.currentArray.length>0)this.history.push({type:this.isOpt,data:[...this.currentArray],originData:this.originCurrent?[...this.originCurrent]:null,selectOpt:!0});else{let t=this.current||t;this.history.push({type:this.isOpt,data:{...t},originData:{...this.originCurrent}})}console.log("this.history",this.history),this.deleteHistory=[]}this.isOpt=""}}mousemove(t){t.preventDefault();const e=this.windowToCanvas(t.clientX,t.clientY);if(this.moveX=e.x,this.moveY=e.y,"down"===this.mouseStatus&&"select"!==this.mode){let s=this.c.parentElement,i=s.clientHeight,h=s.clientWidth,r=this.c.height-i,l=this.c.width-h;e.y-s.scrollTop>=s.clientHeight-2?(clearInterval(this.timerY),this.timerY=setInterval((()=>{this.scrollRateY>=r&&(clearInterval(this.timerY),this.timerY=null),t.clientY-this.tempy<-1?(clearInterval(this.timerY),this.timerY=null):this.tempy=t.clientY,s.scrollTop+=this.scrollRateY/2}),60)):(clearInterval(this.timerY),this.scrollRateY=20),t.clientX>h-2?(clearInterval(this.timerX),this.timerX=setInterval((()=>{this.scrollRateX>=l&&(clearInterval(this.timerX),this.timerX=null),s.scrollLeft+=this.scrollRateX/2}),60)):(clearInterval(this.timerX),this.scrollRateX=20);const o=s.scrollTop;o>0&&t.clientY<80?(clearInterval(this.timerTop),this.timerTop=setInterval((()=>{o<=0&&(clearInterval(this.timerTop),this.timerTop=null),s.scrollTop-=this.scrollRateY/2}),60)):(clearInterval(this.timerTop),this.scrollRateY=20)}if("move"===this.mode&&(this.current?(this.current.x1+this.resize<=this.moveX&&this.current.x2-this.resize>=this.moveX&&this.current.y1+this.resize<=this.moveY&&this.current.y2-this.resize>=this.moveY||"moving"===this.tableStatus?(this.c.style.cursor="move","down"===this.mouseStatus&&this.movetable()):this.c.style.cursor="default","select"!==this.current.type&&this.reSizeTable()):this.currentArray.length>0&&(this.checkMultiple()?(this.c.style.cursor="move","down"===this.mouseStatus&&this.movetable()):this.c.style.cursor="default",this.resizeMultipleCell())),"draw"===this.mode&&"down"===this.mouseStatus||"drawSelect"===this.mode&&"down"===this.mouseStatus){if(this.ctx.save(),this.ctx.beginPath(),this.draw(),this.ctx.setLineDash([5]),this.c.style.cursor="crosshair","drawSelect"===this.mode)this.ctx.strokeStyle=this.selectColor,this.ctx.rect(this.startX,this.startY,this.moveX-this.startX,this.moveY-this.startY);else{this.coord={tr:[],td:[]};for(let t=0;t<=this.drawType.tr;t++)this.ctx.moveTo(this.startX,this.startY+t*(this.moveY-this.startY)/this.drawType.tr),this.ctx.lineTo(this.moveX,this.startY+t*(this.moveY-this.startY)/this.drawType.tr),this.coord.tr.push({x1:this.startX,y1:this.startY+t*(this.moveY-this.startY)/this.drawType.tr,x2:this.moveX,y2:this.startY+t*(this.moveY-this.startY)/this.drawType.tr});for(let t=0;t<=this.drawType.td;t++)this.ctx.moveTo(this.startX+t*(this.moveX-this.startX)/this.drawType.td,this.startY),this.ctx.lineTo(this.startX+t*(this.moveX-this.startX)/this.drawType.td,this.moveY),this.coord.td.push({x1:this.startX+t*(this.moveX-this.startX)/this.drawType.td,y1:this.startY,x2:this.startX+t*(this.moveX-this.startX)/this.drawType.td,y2:this.moveY})}this.isOpt="draw",this.ctx.stroke(),this.ctx.restore()}}clearTimer(){clearInterval(this.timerY),clearInterval(this.timerY),clearInterval(this.timerTop),this.timerY=null,this.timerX=null,this.timerTop=null,this.scrollRateY=20,this.scrollRateX=20,this.tempy=0}checkMultiple(){let t=!1;return this.currentArray.forEach((e=>{(e.x1+this.resize<=this.moveX&&e.x2-this.resize>=this.moveX&&e.y1+this.resize<=this.moveY&&e.y2-this.resize>=this.moveY||"moving"===this.tableStatus)&&(t=!0)})),t}resizeMultipleCell(){if(console.log("批量相应方法"),"moving"===this.tableStatus)return;let t=[...this.currentArray],e="";for(let s=0;s<t.length;s++){if(this.moveX>=t[s].x1&&this.moveX<=t[s].x1+this.resize&&this.moveY>=t[s].y1&&this.moveY<=t[s].y2&&"m-left-resize"!==this.tableStatus){this.moveX>=t[s].x1+1&&(this.c.style.cursor="w-resize"),e="left",this.base=t[s].x1;break}if(this.moveX<t[s].x2&&this.moveX>=t[s].x2-this.resize&&this.moveY>=t[s].y1&&this.moveY<=t[s].y2&&"m-right-resize"!==this.tableStatus){this.moveX<t[s].x2-1&&(this.c.style.cursor="e-resize"),e="right",this.base=t[s].x2;break}if(this.moveX<=t[s].x2-this.resize&&this.moveX>=t[s].x1+this.resize&&this.moveY<=t[s].y1+this.resize&&this.moveY>=t[s].y1&&"m-top-resize"!==this.tableStatus){e="top",this.base=t[s].y1;break}if(this.moveX<=t[s].x2-this.resize&&this.moveX>=t[s].x1+this.resize&&this.moveY<=t[s].y2&&this.moveY>=t[s].y2-this.resize&&"m-bottom-resize"!==this.tableStatus){e="bottom",this.base=t[s].y2;break}}e&&"left"===e||"m-left-resize"===this.tableStatus?("m-left-resize"===this.tableStatus&&(this.c.style.cursor="w-resize"),this.resizeMultipleLeft(this.base,t)):e&&"right"===e||"m-right-resize"===this.tableStatus?(console.log("批量相应 right"),"m-right-resize"===this.tableStatus&&(this.c.style.cursor="e-resize"),this.resizeMultipleRight(this.base,t)):e&&"top"===e||"m-top-resize"===this.tableStatus?this.resizeMultipleTop(this.base,t):(e&&"bottom"===e||"m-bottom-resize"===this.tableStatus)&&this.resizeMultipleBottom(this.base,t)}resizeMultipleLeft(t,e){"down"!==this.mouseStatus||"m-left-resize"!==this.tableStatus&&this.tableStatus||(this.tableStatus="m-left-resize",0===this.cellMatchList.length&&e.forEach((e=>{e.x1>t-this.resize&&e.x1<t+this.resize&&this.cellMatchList.push(e),e.x2>t-this.resize&&e.x2<t+this.resize&&this.cellflowList.push(e)})),this.layers.forEach(((t,e)=>{let s=this.cellMatchList.findIndex((e=>e.key===t.key)),i=this.cellflowList.findIndex((e=>e.key===t.key));if(-1!==s){let i=this.getMinWidthByCellList("max",this.cellMatchList)-2*this.resize,h=this.cellMatchList[s].x1+this.moveX-this.startX<i?this.cellMatchList[s].x1+this.moveX-this.startX:i;if(this.cellflowList.length>0){let t=this.getMinWidthByCellList("min",this.cellflowList)+2*this.resize;h=h<t?t:h}this.layers[e]={...t,x1:h,location:this.getCellLocation("move",{...t,x1:h})}}if(-1!==i){let s=this.getMinWidthByCellList("min",this.cellflowList)+2*this.resize,h=this.getMinWidthByCellList("max",this.cellMatchList)-2*this.resize,r=this.cellflowList[i].x2+this.moveX-this.startX>s?this.cellflowList[i].x2+this.moveX-this.startX:s;r=r<h?r:h,this.layers[e]={...t,x2:r,location:this.getCellLocation("move",{...t,x2:r})}}})),this.isOpt="move",this.draw())}resizeMultipleRight(t,e){"down"!==this.mouseStatus||"m-right-resize"!==this.tableStatus&&this.tableStatus||(this.tableStatus="m-right-resize",0===this.cellMatchList.length&&e.forEach((e=>{e.x2>t-this.resize&&e.x2<t+this.resize&&this.cellMatchList.push(e),e.x1>t-this.resize&&e.x1<t+this.resize&&this.cellflowList.push(e)})),this.layers.forEach(((t,e)=>{let s=this.cellMatchList.findIndex((e=>e.key===t.key)),i=this.cellflowList.findIndex((e=>e.key===t.key));if(-1!==s){let i=this.getMinWidthByCellList("min",this.cellMatchList)+2*this.resize,h=this.cellMatchList[s].x2+this.moveX-this.startX>i?this.cellMatchList[s].x2+this.moveX-this.startX:i;if(this.cellflowList.length>0){let t=this.getMinWidthByCellList("max",this.cellflowList)-2*this.resize;h=h>t?t:h}this.layers[e]={...t,x2:h,location:this.getCellLocation("move",{...t,x2:h})}}if(-1!==i){let s=this.getMinWidthByCellList("min",this.cellMatchList)+2*this.resize,h=this.getMinWidthByCellList("max",this.cellflowList)-2*this.resize,r=this.cellflowList[i].x1+this.moveX-this.startX>s?this.cellflowList[i].x1+this.moveX-this.startX:s;r=r<h?r:h,console.log("x1",r),this.layers[e]={...t,x1:r,location:this.getCellLocation("move",{...t,x1:r})}}})),this.isOpt="move",this.draw())}resizeMultipleTop(t,e){this.c.style.cursor="n-resize","down"!==this.mouseStatus||"m-top-resize"!==this.tableStatus&&this.tableStatus||(this.tableStatus="m-top-resize",0===this.cellMatchList.length&&e.forEach((e=>{e.y1>t-this.resize&&e.y1<t+this.resize&&this.cellMatchList.push(e),e.y2>t-this.resize&&e.y2<t+this.resize&&this.cellflowList.push(e)})),this.layers.forEach(((t,e)=>{let s=this.cellMatchList.findIndex((e=>e.key===t.key)),i=this.cellflowList.findIndex((e=>e.key===t.key));if(-1!==s){let i=this.getMinHeightByCellList("max",this.cellMatchList)-2*this.resize,h=this.cellMatchList[s].y1+this.moveY-this.startY<i?this.cellMatchList[s].y1+this.moveY-this.startY:i;if(this.cellflowList.length>0){let t=this.getMinHeightByCellList("min",this.cellflowList)+2*this.resize;h=h<t?t:h}this.layers[e]={...t,y1:h,location:this.getCellLocation("move",{...t,y1:h})}}if(-1!==i){let s=this.getMinHeightByCellList("min",this.cellflowList)+2*this.resize,h=this.getMinHeightByCellList("max",this.cellMatchList)-2*this.resize,r=this.cellflowList[i].y2+this.moveY-this.startY>s?this.cellflowList[i].y2+this.moveY-this.startY:s;r=r>h?h:r,this.layers[e]={...t,y2:r,location:this.getCellLocation("move",{...t,y2:r})}}})),this.isOpt="move",this.draw())}resizeMultipleBottom(t,e){this.c.style.cursor="s-resize","down"!==this.mouseStatus||"m-bottom-resize"!==this.tableStatus&&this.tableStatus||(this.tableStatus="m-bottom-resize",0===this.cellMatchList.length&&e.forEach((e=>{e.y2>t-this.resize&&e.y2<t+this.resize&&this.cellMatchList.push(e),e.y1>t-this.resize&&e.y1<t+this.resize&&this.cellflowList.push(e)})),this.layers.forEach(((t,e)=>{let s=this.cellMatchList.findIndex((e=>e.key===t.key)),i=this.cellflowList.findIndex((e=>e.key===t.key));if(-1!==s){let i=this.getMinHeightByCellList("min",this.cellMatchList)+2*this.resize,h=this.cellMatchList[s].y2+this.moveY-this.startY>i?this.cellMatchList[s].y2+this.moveY-this.startY:i;if(this.cellflowList.length>0){let t=this.getMinHeightByCellList("max",this.cellflowList)-2*this.resize;h=h>t?t:h}this.layers[e]={...t,y2:h,location:this.getCellLocation("move",{...t,y2:h})}}if(-1!==i){let s=this.getMinHeightByCellList("min",this.cellMatchList)+2*this.resize,h=this.getMinHeightByCellList("max",this.cellflowList)-2*this.resize,r=this.cellflowList[i].y1+this.moveY-this.startY>s?this.cellflowList[i].y1+this.moveY-this.startY:s;r=r>h?h:r,this.layers[e]={...t,y1:r,location:this.getCellLocation("move",{...t,y1:r})}}})),this.isOpt="move",this.draw())}getMinWidthByCellList(t,e){let s=e[0].x1,i=e[0].x2;return e.forEach((t=>{t.x2<i&&(i=t.x2),t.x1>s&&(s=t.x1)})),t?"min"===t?s:i:{min:s,max:i}}getMinHeightByCellList(t,e){let s=e[0].y1,i=e[0].y2;return e.forEach((t=>{t.y2<i&&(i=t.xy),t.y1>s&&(s=t.y1)})),t?"min"===t?s:i:{min:s,max:i}}drawImage(){this.img.src=this.config.url,this.img.key=new Date,this.img.onload=()=>{let t=this.img.width/this.c.width,e=this.img.height/this.c.height,s=t>e?t:e;this.imgRate=s>1?1/s:t>e?(this.c.width-40)/this.img.width:(this.c.height-40)/this.img.height,this.layers.push(this.getImgCoord()),this.drawOriginData(),this.draw()}}drawOriginData(){if(this.config.defaultData&&this.config.defaultData.length>0){let t=this.layers[0]?.x1||0,e=this.layers[0]?.y1||0;this.config.defaultData.forEach((s=>{const i=s.location;i.length>0&&this.layers.push({x1:i[0][0]*this.imgRate+t,y1:i[0][1]*this.imgRate+e,x2:i[1][0]*this.imgRate+t,y2:i[2][1]*this.imgRate+e,strokeStyle:this.drawSelectColor,location:i,type:"cell",w:1,h:1,key:(new Date).getTime()+"cell"+i[0][0]+t+i[0][1]+e})})),this.draw()}}getImgCoord(){let t=this.img.width*this.imgRate,e=this.img.height*this.imgRate+20,s=0;return t<this.c.width&&(s=(this.c.width-t)/2),t>this.c.width&&(this.c.width=t),e>this.c.height&&(this.c.height=e),t<this.c.width&&e<this.c.height&&(this.c.width=t>document.body.clientWidth?t:document.body.clientWidth,this.c.height=e>document.body.clientHeight-64?e:document.body.clientHeight-64),{type:"img",x1:s,x2:s+t,y1:20,y2:e,isOpt:!1,key:(new Date).getTime()+"img"+s+0}}draw(){this.ctx.clearRect(0,0,this.c.width,this.c.height);let t=[];this.layers.forEach((e=>{if(this.ctx.beginPath(),this.ctx.setLineDash([]),this.ctx.lineWidth=1,"img"===e.type)this.ctx.drawImage(this.img,e.x1,e.y1,e.x2-e.x1,e.y2-e.y1);else if("cell"===e.type||"select"===e.type)this.current&&this.current.key===e.key||this.currentArray.length>0&&-1!==this.currentArray.findIndex((t=>t.key===e.key))?t.push(e):(e.strokeStyle=this.drawSelectColor,this.ctx.rect(e.x1,e.y1,e.x2-e.x1,e.y2-e.y1));else if("table"===e.type){this.current&&this.current.key===e.key?(e.strokeStyle=this.selectActiveColor,e.lineWidth=2):e.strokeStyle=this.drawSelectColor,this.currentArray.length>0&&this.current&&"select"===this.current.type&&-1!==this.currentArray.findIndex((t=>t.key===e.key))&&(e.strokeStyle=this.selectActiveColor,e.lineWidth=2);for(let t=0;t<=e.h;t++)this.ctx.moveTo(e.coord.tr[t].x1,e.coord.tr[t].y1),this.ctx.lineTo(e.coord.tr[t].x2,e.coord.tr[t].y2);for(let t=0;t<=e.w;t++)this.ctx.moveTo(e.coord.td[t].x1,e.coord.td[t].y1),this.ctx.lineTo(e.coord.td[t].x2,e.coord.td[t].y2)}this.ctx.strokeStyle=e.strokeStyle,this.ctx.lineWidth=e.lineWidth||1,this.ctx.stroke()})),console.log("arr",t),t.forEach((t=>{this.ctx.beginPath(),this.ctx.rect(t.x1,t.y1,t.x2-t.x1,t.y2-t.y1),this.ctx.strokeStyle=this.selectActiveColor,this.ctx.lineWidth=2,this.ctx.stroke()}))}getScroll(){return{top:this.ctx.parent.scrollTop,left:this.ctx.parent.scrollLeft}}zoom(t){if("up"===t)this.imgRate+=.1;else if(this.imgRate<=.2){if(this.imgRate<=.02)return;this.imgRate-=.01}else this.imgRate-=.1;if(this.Recalculate(),this.current){let t=this.layers.findIndex((t=>t.key===this.current.key));this.current={index:t,...this.layers[t]}}if(this.currentArray.length>0){let t=[];this.layers.forEach((e=>{-1!==this.currentArray.findIndex((t=>t.key===e.key))&&t.push(e)})),this.currentArray=[...t]}}Recalculate(){let t=0,e=0;"image"===this.layers[0].type&&(this.layers[0]=this.getImgCoord(),t=this.layers[0].x1,e=this.layers[0].y1),this.layers.forEach((s=>{if("img"!==s.type&&s.location&&(s.x1=s.location[0][0]*this.imgRate+t,s.y1=s.location[0][1]*this.imgRate+e,s.x2=s.location[1][0]*this.imgRate+t,s.y2=s.location[2][1]*this.imgRate+e,"table"===s.type)){let i=[],h=[];s.coordLocation.td.forEach((s=>{i.push({x1:s.x1*this.imgRate+t,x2:s.x2*this.imgRate+t,y1:s.y1*this.imgRate+e,y2:s.y2*this.imgRate+e})})),s.coordLocation.tr.forEach((s=>{h.push({x1:s.x1*this.imgRate+t,x2:s.x2*this.imgRate+t,y1:s.y1*this.imgRate+e,y2:s.y2*this.imgRate+e})})),s.coord={td:i,tr:h}}})),this.draw()}isPointInRetc(t,e){for(let s=0;s<this.layers.length;s++)if(("table"===this.layers[s].type||"cell"===this.layers[s].type||"select"===this.layers[s].type)&&this.layers[s].x1<=t&&t<=this.layers[s].x2&&this.layers[s].y1<=e&&e<=this.layers[s].y2)return{...this.layers[s],index:s}}windowToCanvas(t,e){const s=this.c.getBoundingClientRect();return{x:t-s.left,y:e-s.top}}reSizeTable(){if(this.moveX>=this.current.x1&&this.moveX<=this.current.x1+this.resize&&this.moveY>=this.current.y1&&this.moveY<=this.current.y2||"left-resize"===this.tableStatus)this.resizeLeft();else if(this.moveX<=this.current.x2&&this.moveX>=this.current.x2-this.resize&&this.moveY>=this.current.y1&&this.moveY<=this.current.y2||"right-resize"===this.tableStatus)this.resizeRight();else if(this.moveY>=this.current.y1&&this.moveY<=this.current.y1+this.resize&&this.moveX>=this.current.x1+this.resize&&this.moveX<=this.current.x2-this.resize||"top-resize"===this.tableStatus)this.resizeTop();else if(this.moveY>=this.current.y2-this.resize&&this.moveY<this.current.y2&&this.moveX>=this.current.x1+this.resize&&this.moveX<this.current.x2-this.resize||"bottom-resize"===this.tableStatus)this.resizeBottom();else if(this.moveX>=this.current.x1&&this.moveX<=this.current.x1+this.resize&&this.moveY>=this.current.y1&&this.moveY<=this.current.y1+this.resize||"lt-resize"===this.tableStatus)this.resizeLT();else if(this.moveX<=this.current.x2&&this.moveX>=this.current.x2-this.resize&&this.moveY>=this.current.y1&&this.moveY<=this.current.y1+this.resize||"rt-resize"===this.tableStatus)this.resizeRT();else if(this.moveX>=this.current.x1&&this.moveX<=this.current.x1+this.resize&&this.moveY<=this.current.y2&&this.moveY>=this.current.y2-this.resize||"lb-resize"===this.tableStatus)this.resizeBL();else if(this.moveX<=this.current.x2&&this.moveX>=this.current.x2-this.resize&&this.moveY<=this.current.y2&&this.moveY>=this.current.y2-this.resize||"rb-resize"===this.tableStatus)this.resizeBR();else if("table"===this.current.type&&this.moveX>this.current.x1+this.resize&&this.moveX<this.current.x2-this.resize&&this.moveY>this.current.y1+this.resize&&this.moveY<this.current.y2-this.resize){let t=[...this.current.coord.td],e=[...this.current.coord.tr],s=!1;for(let t=1;t<e.length-1;t++)if(this.moveY>e[t].y1-this.resize&&this.moveY<e[t].y1+this.resize&&"table-resize"!==this.tableStatus){s=!0,this.match.type="tr",this.match.index=t,this.c.style.cursor="n-resize";break}for(let e=1;e<t.length-1;e++)if(this.moveX>t[e].x1-this.resize&&this.moveX<t[e].x1+this.resize&&"table-resize"!==this.tableStatus){s=!0,this.match.type="td",this.match.index=e,this.c.style.cursor="w-resize";break}!s&&"table-resize"!==this.tableStatus||"down"!==this.mouseStatus||this.resizeTableLine(this.match)}}movetable(){if(!this.tableStatus||"moving"===this.tableStatus)if(console.log("move fate",this.tableStatus),this.tableStatus="moving",this.current){const t=this.moveX-this.leftDistance-this.current.x1,e=this.moveY-this.topDistance-this.current.y1;if(this.current.x2+=t,this.current.x1+=t,this.current.y2+=e,this.current.y1+=e,"table"===this.current.type){let s=[],i=[];this.current.coord.tr.forEach((i=>{s.push({x1:i.x1+t,y1:i.y1+e,x2:i.x2+t,y2:i.y2+e})})),this.current.coord.td.forEach((s=>{i.push({x1:s.x1+t,y1:s.y1+e,x2:s.x2+t,y2:s.y2+e})})),this.current.coord={tr:s,td:i}}else"select"===this.current.type&&this.currentArray.length>0&&this.layers.forEach(((s,i)=>{this.currentArray.forEach((h=>{if(h.key===s.key&&(this.layers[i].x2+=t,this.layers[i].x1+=t,this.layers[i].y2+=e,this.layers[i].y1+=e,this.layers[i].location=this.getCellLocation("move",s),"table"===s.type)){let h=[],r=[];s.coord.tr.forEach((s=>{h.push({x1:s.x1+t,y1:s.y1+e,x2:s.x2+t,y2:s.y2+e})})),s.coord.td.forEach((s=>{r.push({x1:s.x1+t,y1:s.y1+e,x2:s.x2+t,y2:s.y2+e})})),this.layers[i].coord={td:r,tr:h},this.layers[i].coordLocation=this.getTableLocation("move",s)}}))}));this.dealData("move")}else if(this.currentArray.length>0){let t="";this.currentArray.forEach((e=>{t=e.index?e.index:this.layers.findIndex((t=>t.key===e.key)),this.layers[t]={...this.layers[t],x1:e.x1+this.moveX-this.startX,x2:e.x2+this.moveX-this.startX,y1:e.y1+this.moveY-this.startY,y2:e.y2+this.moveY-this.startY},this.layers[t].location=this.getCellLocation("move",this.layers[t])})),this.isOpt="move",this.draw()}}resizeLeft(){if(this.c.style.cursor="w-resize","down"===this.mouseStatus&&"lt-resize"!==this.tableStatus&&"lb-resize"!==this.tableStatus){if(this.tableStatus="left-resize",this.current.x1=this.moveX>this.current.x2-this.resize?this.current.x2-this.resize:this.moveX,"table"===this.current.type){let t=[],e=[...this.current.coord.td];this.current.coord.tr.forEach((s=>{t.push({x1:this.moveX>e[1].x1-this.resize?e[1].x1-this.resize:this.moveX,y1:s.y1,x2:s.x2,y2:s.y2})})),e[0].x1=this.moveX>e[1].x1-this.resize?e[1].x1-this.resize:this.moveX,e[0].x2=this.moveX>e[1].x1-this.resize?e[1].x1-this.resize:this.moveX,this.current.coord={tr:t,td:e}}this.dealData()}}resizeRight(){if(this.c.style.cursor="e-resize","down"===this.mouseStatus&&"rt-resize"!==this.tableStatus&&"rb-resize"!==this.tableStatus){if(this.tableStatus="right-resize",this.current.x2=this.moveX<this.current.x1+this.resize?this.current.x1+this.resize:this.moveX,"table"===this.current.type){let t=[],e=[];e=[...this.current.coord.td],this.current.coord.tr.forEach((s=>{t.push({x1:s.x1,y1:s.y1,x2:this.moveX>e[e.length-2].x2+this.resize?this.moveX:e[e.length-2].x2+this.resize,y2:s.y2})})),e[e.length-1].x1=this.moveX>e[e.length-2].x2+this.resize?this.moveX:e[e.length-2].x1+this.resize,e[e.length-1].x2=this.moveX>e[e.length-2].x2+this.resize?this.moveX:e[e.length-2].x1+this.resize,this.current.coord={tr:t,td:e}}this.dealData()}}resizeTop(){if(this.c.style.cursor="n-resize","down"===this.mouseStatus&&"lt-resize"!==this.tableStatus&&"rt-resize"!==this.tableStatus){if(this.tableStatus="top-resize",this.current.y1=this.moveY>this.current.y2-this.resize?this.current.y2-this.resize:this.moveY,"table"===this.current.type){let t=[],e=[];t=[...this.current.coord.tr],this.current.coord.td.forEach((s=>{e.push({x1:s.x1,y1:this.moveY>t[1].y1-this.resize?t[1].y1-this.resize:this.moveY,x2:s.x2,y2:s.y2})})),t[0].y1=this.moveY>t[1].y1-this.resize?t[1].y1-this.resize:this.moveY,t[0].y2=this.moveY>t[1].y1-this.resize?t[1].y1-this.resize:this.moveY,this.current.coord={tr:t,td:e}}this.dealData()}}resizeBottom(){if(this.c.style.cursor="s-resize","down"===this.mouseStatus&&"lb-resize"!==this.tableStatus&&"rb-resize"!==this.tableStatus){if(this.tableStatus="bottom-resize",this.current.y2=this.moveY<this.current.y1+this.resize?this.current.y1+this.resize:this.moveY,"table"===this.current.type){let t=[],e=[];t=[...this.current.coord.tr],this.current.coord.td.forEach((s=>{e.push({x1:s.x1,y1:s.y1,x2:s.x2,y2:this.moveY>t[t.length-2].y2+this.resize?this.moveY:t[t.length-2].y2+this.resize})})),t[t.length-1].y1=this.moveY>t[t.length-2].y2+this.resize?this.moveY:t[t.length-2].y2+this.resize,t[t.length-1].y2=this.moveY>t[t.length-2].y2+this.resize?this.moveY:t[t.length-2].y2+this.resize,this.current.coord={tr:t,td:e}}this.dealData()}}resizeLT(){if(this.c.style.cursor="nw-resize","down"===this.mouseStatus){this.tableStatus="lt-resize";const t=this.moveY-this.current.y1;if(this.current.x1=this.moveX,this.current.y1=this.moveY,"table"===this.current.type){let e=[],s=[];this.current.coord.tr.forEach((t=>{e.push({x1:this.moveX>this.current.coord.td[1].x1-this.resize?this.current.coord.td[1].x1-this.resize:this.moveX,y1:t.y1,x2:t.x2,y2:t.y2})})),e[0].y1+=t,e[0].y2+=t,this.current.coord.td.forEach((e=>{s.push({x1:e.x1,y1:e.y1+t,x2:e.x2,y2:e.y2})})),s[0].x1=this.moveX>s[1].x1-this.resize?s[1].x1-this.resize:this.moveX,s[0].x2=this.moveX>s[1].x1-this.resize?s[1].x1-this.resize:this.moveX,this.current.coord={tr:e,td:s}}this.dealData()}}resizeRT(){if(this.c.style.cursor="ne-resize","down"===this.mouseStatus){this.tableStatus="rt-resize";const t=this.moveY-this.current.y1;if(this.current.x2=this.moveX,this.current.y1=this.moveY,"table"===this.current.type){let e=[],s=[];this.current.coord.tr.forEach((t=>{e.push({x1:t.x1,y1:t.y1,x2:this.moveX,y2:t.y2})})),e[0].y1+=t,e[0].y2+=t,this.current.coord.td.forEach((e=>{s.push({x1:e.x1,y1:e.y1+t,x2:e.x2,y2:e.y2})})),s[s.length-1].x1=this.moveX,s[s.length-1].x2=this.moveX,this.current.coord={tr:e,td:s}}this.dealData()}}resizeBL(){if(this.c.style.cursor="sw-resize","down"===this.mouseStatus){this.tableStatus="lb-resize";const t=this.moveY-this.current.y2;if(this.current.x1=this.moveX,this.current.y2=this.moveY,"table"===this.current.type){let e=[],s=[];this.current.coord.tr.forEach((t=>{e.push({x1:this.moveX,y1:t.y1,x2:t.x2,y2:t.y2})})),e[e.length-1].y1+=t,e[e.length-1].y2+=t,this.current.coord.td.forEach((e=>{s.push({x1:e.x1,y1:e.y1,x2:e.x2,y2:e.y2+t})})),s[0].x1=this.moveX,s[0].x2=this.moveX,this.current.coord={tr:e,td:s}}this.dealData()}}resizeBR(){if(this.c.style.cursor="se-resize","down"===this.mouseStatus){this.tableStatus="rb-resize";const t=this.moveY-this.current.y2;if(this.current.x2=this.moveX,this.current.y2=this.moveY,"table"===this.current.type){let e=[],s=[];this.current.coord.tr.forEach((t=>{e.push({x1:t.x1,y1:t.y1,x2:this.moveX,y2:t.y2})})),e[e.length-1].y1+=t,e[e.length-1].y2+=t,this.current.coord.td.forEach((e=>{s.push({x1:e.x1,y1:e.y1,x2:e.x2,y2:e.y2+t})})),s[s.length-1].x1=this.moveX,s[s.length-1].x2=this.moveX,this.current.coord={tr:e,td:s}}this.dealData()}}resizeTableLine(t){let e=[...this.current.coord.td],s=[...this.current.coord.tr];if(this.tableStatus="table-resize","td"===t.type){const s=Object.assign({},e[t.index]);let i=e[t.index-1].x1+3*this.resize,h=e[t.index+1].x1-3*this.resize;e[t.index]={...s,x1:this.moveX<i?i:this.moveX>h?h:this.moveX,x2:this.moveX<i?i:this.moveX>h?h:this.moveX}}else{const e=Object.assign({},s[t.index]);let i=s[t.index-1].y1+3*this.resize,h=s[t.index+1].y1-3*this.resize;s[t.index]={...e,y1:this.moveY<i?i:this.moveY>h?h:this.moveY,y2:this.moveY<i?i:this.moveY>h?h:this.moveY}}this.current.coord={td:e,tr:s},this.dealData()}dealData(t){this.isOpt=t||"resize",this.current.location=this.getCellLocation("move",this.current),"table"===this.current.type&&(this.current.coordLocation=this.getTableLocation("move",this.current));let e=0;e=this.current.index?this.current.index:this.layers.findIndex((t=>t.key===this.current.key)),this.layers[e]=this.current,this.draw()}getCellLocation(t,e){let s=0,i=0;"iamge"===this.layers[0].type&&(s=this.layers[0].x1,i=this.layers[0].y1);let h=(("draw"===t?this.startX:e.x1)-s)/this.imgRate,r=(("draw"===t?this.startY:e.y1)-i)/this.imgRate,l=(("draw"===t?this.moveX:e.x2)-s)/this.imgRate,o=(("draw"===t?this.moveY:e.y2)-i)/this.imgRate;return[[h,r],[l,r],[h,o],[l,o]]}getTableLocation(t,e){let s=0,i=0;"iamge"===this.layers[0].type&&(s=this.layers[0].x1,i=this.layers[0].y1);let h=[],r=[],l="draw"===t?this.coord:e.coord;return l.tr.forEach((t=>{r.push({x1:(t.x1-s)/this.imgRate,y1:(t.y1-i)/this.imgRate,x2:(t.x2-s)/this.imgRate,y2:(t.y2-i)/this.imgRate})})),l.td.forEach((t=>{h.push({x1:(t.x1-s)/this.imgRate,y1:(t.y1-i)/this.imgRate,x2:(t.x2-s)/this.imgRate,y2:(t.y2-i)/this.imgRate})})),{tr:r,td:h}}revoke(){if(this.history.length>=1){let t=this.history.pop();if(console.log("revoke",t,this.history),"move"===t.type||"resize"===t.type)if(t.selectOpt)this.layers.forEach(((e,s)=>{t.originData.forEach((t=>{t.key===e.key&&(this.layers[s]=t,console.log("ccc",this.layers[s],t))}))}));else{let e=this.layers.findIndex((e=>e.key===t.data.key));this.layers[e]=t.originData}else if("delete"===t.type)t.selectOpt?(console.log("infoiunfo",t),this.layers=this.layers.concat(t.originData)):this.layers.push(t.originData);else if("draw"===t.type)if(t.data instanceof Array){let e=[];this.layers.forEach((s=>{let i=!1;t.data.forEach((t=>{s.key===t.key&&(i=!0)})),i||e.push(s)})),this.layers=[...e],t.originData=[...t.data]}else{let e=this.layers.findIndex((e=>e.key===t.data.key));t.originData=this.layers[e],this.layers.splice(e,1)}this.deleteHistory.push(t),console.log("this.deleteHistory",this.deleteHistory),this.draw()}}reRevoke(){if(this.deleteHistory.length>0){let t=this.deleteHistory.pop();if(console.log("reer",t),"move"===t.type||"resize"===t.type)if(t.selectOpt)this.layers.forEach(((e,s)=>{t.data.forEach((t=>{t.key===e.key&&(this.layers[s]=t)}))}));else{let e=this.layers.findIndex((e=>e.key===t.data.key));console.log("index",e),this.layers[e]={...t.data}}else if("delete"===t.type)if(t.selectOpt){let e=[];this.layers.forEach((s=>{let i=!1;t.originData.forEach((t=>{t.key===s.key&&(i=!0)})),i||e.push(s)})),this.layers=e}else{let e=this.layers.findIndex((e=>e.key===t.originData.key));this.layers.splice(e,1)}else"draw"===t.type&&(t.originData instanceof Array?this.layers=this.layers.concat(t.originData):this.layers.push(t.originData));this.history.push(t),this.draw()}}delete(){if(console.log("delet"),this.current){if("select"===this.current.type){let t=[],e=[];this.layers.forEach((s=>{let i=!1;this.currentArray.forEach((t=>{s.key===t.key&&(i=!0)})),i?e.push(s):t.push(s)})),this.history.push({type:"delete",selectOpt:!0,data:"",originData:[...e]}),console.log("this.history select",this.history),this.layers=t}else{this.history.push({type:"delete",data:"",originData:this.current}),console.log("this.history",this.history);let t=this.layers.findIndex((t=>t.key===this.current.key));this.layers.splice(t,1)}this.noUpdate=this.checkIsSave(),this.current=null,this.draw(),this.c.style.cursor="default"}else if(this.currentArray.length>0){let t=[],e=[];this.layers.forEach((s=>{-1===this.currentArray.findIndex((t=>t.key===s.key))?t.push(s):e.push(s)})),this.history.push({type:"delete",selectOpt:!0,data:[],originData:[...e]}),this.layers=[...t],this.currentArray=[],this.noUpdate=this.checkIsSave(),this.draw(),this.c.style.cursor="default"}}removeSelect(){var t=this.layers.findIndex((t=>"select"===t.type));-1!==t&&this.layers.splice(t,1)}fixPosition(t){if(t.x1>t.x2){let e=t.x1;t.x1=t.x2,t.x2=e}if(t.y1>t.y2){let e=t.y1;t.y1=t.y2,t.y2=e}return t}findSelectArray(t){this.currentArray=[],this.layers.forEach((e=>{e.x1>=t.x1&&e.x2<=t.x2&&e.y1>=t.y1&&e.y2<=t.y2&&"select"!==e.type&&"img"!==e.type&&this.currentArray.push({...e})})),console.log("current",this.currentArray)}saveDraw(t=""){let e=[],s=0,i=0;"iamge"===this.layers[0].type&&(s=this.layers[0].x1,i=this.layers[0].y1);let h={};this.layers.forEach((t=>{if("cell"===t.type){let h=parseInt((t.x1-s)/this.imgRate),r=parseInt((t.y1-i)/this.imgRate),l=parseInt((t.x2-s)/this.imgRate),o=parseInt((t.y2-i)/this.imgRate);e.push({...t,location:[[h,r],[l,r],[l,o],[h,o]],x1:h,y1:r,x2:l,y2:o})}else if("table"===t.type){let h=this.transTable(t,s,i);e.push(...h)}})),e.sort(((t,e)=>Number(t.y1)-Number(e.y1)));for(let t=0;t<e.length;t++)h[e[t].y1]?h[e[t].y1].push(e[t]):h[e[t].y1]=[e[t]];let r=[];return Object.keys(h).sort(((t,e)=>t-e)).forEach((t=>{let e=h[t];e.sort(((t,e)=>t.x1-e.x1)),r.push(...e)})),t||(this.saveCurrent=[...r],this.history=[],this.deleteHistory=[],this.current=null,this.noUpdate=!0),r}transTable(t,e,s){let i=t.coord.td,h=t.coord.tr,r=[];for(let l=0;l<t.w;l++)for(let o=0;o<t.h;o++){let a=parseInt((i[l].x1-e)/this.imgRate),c=parseInt((h[o].y1-s)/this.imgRate),n=parseInt((i[l+1].x1-e)/this.imgRate),y=parseInt((h[o+1].y1-s)/this.imgRate);r.push({...t,location:[[a,c],[n,c],[n,y],[a,y]],x1:a,y1:c,x2:n,y2:y})}return r}setMode(t,e={type:"cell",tr:1,td:1}){this.mode=t||"select","draw"===t?(this.c.style.cursor="crosshair",this.drawType=e,this.current=null,this.currentArray=[]):(this.draw.drawType={},"drawSelect"===t&&(this.c.style.cursor="crosshair",this.current=null,this.currentArray=[])),this.draw()}resetConfig(t){this.config=Object.assign(this.config,t),this.layers=[],this.current=null,this.imgRate=1,this.history=[],this.noUpdate=!0,this.deleteHistory=[],this.currentArray=[],this.saveCurrent=[],this.c.width=document.body.clientWidth,this.c.height=document.body.clientHeight-64,this.mode="select",this.config.url?this.drawImage():this.drawOriginData()}checkIsSave(){let t=!0;const e=this.saveDraw("check");if(this.saveCurrent.length===e.length)for(let s=0;s<this.saveCurrent.length;s++)this.saveCurrent[s].x1===e[s].x1&&this.saveCurrent[s].x2===e[s].x2&&this.saveCurrent[s].y1===e[s].y1&&this.saveCurrent[s].y2===e[s].y2||(t=!1);else t=!1;return t}}const i=function(){let t=null;return(e,i)=>(t?t.resetConfig({}):t=new s(e,i),t)}();return e})()));